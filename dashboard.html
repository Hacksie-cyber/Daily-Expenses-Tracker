<!DOCTYPE html>
<html lang="en" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Expenses Tracker Dashboard</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Chart.js for visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        :root {
            --bg-body: #f3f4f6;
            --bg-card: #ffffff;
            --bg-section: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-muted: #6b7280;
            --border-color: #d1d5db;
        }

        .dark-theme {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --bg-section: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #e5e7eb;
            --text-muted: #9ca3af;
            --border-color: #4b5563;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
        }

        .card {
            background-color: var(--bg-card);
            color: var(--text-primary);
        }

        .section {
            background-color: var(--bg-section);
        }

        .text-primary {
            color: var(--text-primary);
        }
        
        .text-secondary {
            color: var(--text-secondary);
        }
        
        .text-muted {
            color: var(--text-muted);
        }
        
        .border-color {
            border-color: var(--border-color);
        }
        
        .input-field {
            background-color: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-color);
        }

        .modal {
            transition: visibility 0s, opacity 0.3s ease-in-out;
        }

        .modal.open {
            visibility: visible;
        }

        .modal-content {
            transform: translateY(-20px);
            transition: transform 0.3s ease-in-out;
        }

        .modal.open .modal-content {
            transform: translateY(0);
        }

        #report-modal-content {
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        #report-modal-list-container {
            overflow-y: auto;
            flex-grow: 1;
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
            scrollbar-width: none;  /* Firefox */
        }
        #report-modal-list-container::-webkit-scrollbar {
            display: none;  /* Safari and Chrome */
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-4 transition-colors duration-300">

    <!-- Main Container: Adjusted padding for mobile -->
    <div class="w-full max-w-5xl card rounded-3xl shadow-xl p-4 sm:p-8 transform transition-colors duration-300">
        <header class="flex flex-col sm:flex-row items-center justify-between mb-4 sm:mb-8">
            <h1 class="text-3xl font-bold text-center sm:text-left text-primary mb-4 sm:mb-0">Daily Expenses Tracker</h1>
            <div class="flex items-center space-x-4">
                <button id="theme-toggle" class="p-2 rounded-full text-secondary hover:bg-gray-200 hover:text-primary dark:hover:bg-gray-700 dark:hover:text-white transition duration-300">
                    <i class="fas fa-moon" id="moon-icon"></i>
                    <i class="fas fa-sun hidden" id="sun-icon"></i>
                </button>
                <span id="user-email" class="text-secondary text-sm font-medium"></span>
                <button id="logout-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg font-semibold hover:bg-red-600 transition duration-300">Logout</button>
            </div>
        </header>

        <!-- New Layout for Desktop: Two-column grid for medium screens and up -->
        <div class="flex flex-col md:flex-row md:space-x-8">

            <!-- Left Column: Forms for adding expenses and setting budget -->
            <div class="flex flex-col md:w-1/2">
                <!-- Add New Expense Section -->
                <section class="mb-8 p-6 section rounded-2xl transition-colors duration-300">
                    <h2 class="text-2xl font-semibold text-primary mb-4">Add New Expense</h2>
                    <form id="add-expense-form" class="space-y-4">
                        <div>
                            <label for="expense-amount" class="block text-secondary font-medium mb-2">Amount</label>
                            <input type="number" id="expense-amount" required class="w-full px-4 py-2 border border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-field transition duration-300" placeholder="e.g. 25.50">
                        </div>
                        <div>
                            <label for="expense-category" class="block text-secondary font-medium mb-2">Category</label>
                            <select id="expense-category" required class="w-full px-4 py-2 border border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-field transition duration-300">
                                <option value="">Select Category</option>
                                <option value="Food">Food</option>
                                <option value="Shopping">Shopping</option>
                                <option value="Bills">Bills</option>
                                <option value="Entertainment">Entertainment</option>
                                <option value="Transportation">Transportation</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div>
                            <label for="expense-description" class="block text-secondary font-medium mb-2">Description</label>
                            <input type="text" id="expense-description" required class="w-full px-4 py-2 border border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-field transition duration-300" placeholder="e.g. Lunch at the cafe">
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-300">Add Expense</button>
                    </form>
                </section>

                <!-- Monthly Budget Section -->
                <section class="mb-8 p-6 section rounded-2xl transition-colors duration-300">
                    <h2 class="text-2xl font-semibold text-primary mb-4">Monthly Budget</h2>
                    <form id="set-budget-form" class="flex flex-col sm:flex-row items-end sm:items-center space-y-4 sm:space-y-0 sm:space-x-4">
                        <div class="flex-grow w-full">
                            <label for="monthly-budget-input" class="block text-secondary font-medium mb-2">Set Your Monthly Budget</label>
                            <input type="number" id="monthly-budget-input" required class="w-full px-4 py-2 border border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-field transition duration-300" placeholder="e.g. 5000">
                        </div>
                        <button type="submit" class="w-full sm:w-auto bg-green-600 text-white py-2 px-6 rounded-lg font-semibold hover:bg-green-700 transition duration-300">Set Budget</button>
                    </form>
                    
                    <div class="mt-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-secondary font-medium">Budget: <span id="budget-amount" class="text-primary font-bold">₱0.00</span></span>
                            <span class="text-secondary font-medium">Spent: <span id="monthly-spent" class="text-primary font-bold">₱0.00</span></span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-4 dark:bg-gray-700 overflow-hidden">
                            <div id="budget-progress-bar" class="h-4 bg-blue-600 rounded-full transition-all duration-500" style="width: 0%;"></div>
                        </div>
                        <p id="budget-message" class="text-sm mt-2 text-center text-muted">Set a budget to start tracking!</p>
                    </div>
                </section>
            </div>

            <!-- Right Column: Summary Section -->
            <div class="flex flex-col md:w-1/2">
                <!-- Expense Summary Section -->
                <section class="mb-8 p-6 section rounded-2xl transition-colors duration-300">
                    <h2 class="text-2xl font-semibold text-primary mb-4">Expense Summary</h2>
                    <div class="grid grid-cols-2 gap-4 text-center">
                        <div class="p-4 rounded-xl card shadow-sm">
                            <p class="text-muted text-sm mb-1">Today</p>
                            <p id="daily-total" class="text-xl font-bold text-blue-600 dark:text-blue-400">₱0.00</p>
                        </div>
                        <div class="p-4 rounded-xl card shadow-sm">
                            <p class="text-muted text-sm mb-1">This Week</p>
                            <p id="weekly-total" class="text-xl font-bold text-blue-600 dark:text-blue-400">₱0.00</p>
                        </div>
                        <div class="p-4 rounded-xl card shadow-sm">
                            <p class="text-muted text-sm mb-1">This Month</p>
                            <p id="monthly-total" class="text-xl font-bold text-blue-600 dark:text-blue-400">₱0.00</p>
                        </div>
                        <div class="p-4 rounded-xl card shadow-sm">
                            <p class="text-muted text-sm mb-1">This Year</p>
                            <p id="yearly-total" class="text-xl font-bold text-blue-600 dark:text-blue-400">₱0.00</p>
                        </div>
                    </div>
                    <div class="mt-6 text-center">
                        <button id="view-expenses-btn" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-300">View All Expenses</button>
                    </div>
                </section>
            </div>
        </div>

        <!-- Charts Section: Now smaller and with updated axes -->
        <section class="mb-8 p-6 section rounded-2xl transition-colors duration-300">
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold text-primary mb-2 sm:mb-0">Statistics</h2>
                <select id="report-time-period" class="px-3 py-1 rounded-md border border-color input-field">
                    <option value="daily">Today</option>
                    <option value="weekly" selected>This Week</option>
                    <option value="monthly">This Month</option>
                    <option value="yearly">This Year</option>
                </select>
            </div>
            
            <!-- Container to make charts smaller -->
            <div class="w-full max-w-xl mx-auto space-y-8">
                <div>
                    <h4 class="text-xl font-semibold text-primary text-center mb-2">Category Breakdown</h4>
                    <canvas id="expense-pie-chart"></canvas>
                </div>
                <div>
                    <h4 class="text-xl font-semibold text-primary text-center mb-2">Spending Trends</h4>
                    <canvas id="expense-line-chart"></canvas>
                </div>
            </div>
        </section>

        <!-- Feedback & Rating Section -->
        <section class="mb-8 p-6 section rounded-2xl transition-colors duration-300">
            <h2 class="text-2xl font-semibold text-primary mb-4">Share Your Feedback</h2>
            <form id="feedback-form" class="space-y-4">
                <div>
                    <label class="block text-secondary font-medium mb-2">Your Rating</label>
                    <div id="rating-stars" class="flex space-x-1">
                        <i class="fas fa-star text-2xl cursor-pointer text-gray-400" data-rating="1"></i>
                        <i class="fas fa-star text-2xl cursor-pointer text-gray-400" data-rating="2"></i>
                        <i class="fas fa-star text-2xl cursor-pointer text-gray-400" data-rating="3"></i>
                        <i class="fas fa-star text-2xl cursor-pointer text-gray-400" data-rating="4"></i>
                        <i class="fas fa-star text-2xl cursor-pointer text-gray-400" data-rating="5"></i>
                    </div>
                    <input type="hidden" id="feedback-rating" required>
                </div>
                <div>
                    <label for="feedback-comment" class="block text-secondary font-medium mb-2">Your Comments</label>
                    <textarea id="feedback-comment" rows="4" required class="w-full px-4 py-2 border border-color rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 input-field transition duration-300" placeholder="Tell us what you think!"></textarea>
                </div>
                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 transition duration-300">Submit Feedback</button>
            </form>
            <div class="mt-8">
                <h3 class="text-xl font-semibold text-primary mb-4">What others are saying...</h3>
                <ul id="feedback-list" class="space-y-4">
                    <!-- Feedback will be dynamically added here -->
                    <li id="no-feedback-message" class="text-center text-muted">No feedback yet. Be the first to share your thoughts!</li>
                </ul>
            </div>
        </section>

        <!-- Footer -->
        <footer class="text-center py-4 mt-8 w-full">
            <p class="text-sm text-muted">© 2025 Daily Expenses Tracker. All rights reserved.</p>
        </footer>

    </div>

    <!-- Modal for general messages -->
    <div id="messageModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] invisible opacity-0">
        <div class="modal-content card p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h3 id="modalTitle" class="text-xl font-bold mb-3 text-primary"></h3>
            <p id="modalMessage" class="text-secondary mb-4"></p>
            <button id="closeModalBtn" class="px-6 py-2 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition duration-300">OK</button>
        </div>
    </div>

    <!-- Confirmation Modal for Deleting Expense -->
    <div id="confirmationModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] invisible opacity-0">
        <div class="modal-content card p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-3 text-primary">Confirm Deletion</h3>
            <p class="text-secondary mb-6">Are you sure you want to delete this expense? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelDeleteBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-300">Cancel</button>
                <button id="confirmDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-300">Delete</button>
            </div>
        </div>
    </div>
    
    <!-- Confirmation Modal for Deleting Feedback -->
    <div id="feedbackConfirmationModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[60] invisible opacity-0">
        <div class="modal-content card p-6 rounded-xl shadow-lg w-full max-w-sm text-center">
            <h3 class="text-xl font-bold mb-3 text-primary">Delete Feedback</h3>
            <p class="text-secondary mb-6">Are you sure you want to delete your feedback? This action cannot be undone.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancelFeedbackDeleteBtn" class="px-6 py-2 bg-gray-500 text-white rounded-lg font-semibold hover:bg-gray-600 transition duration-300">Cancel</button>
                <button id="confirmFeedbackDeleteBtn" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition duration-300">Delete</button>
            </div>
        </div>
    </div>

    <!-- Modal for Expense Report -->
    <div id="reportModal" class="modal fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 invisible opacity-0">
        <div id="report-modal-content" class="modal-content card p-6 rounded-xl shadow-lg w-full max-w-2xl text-left">
            <div class="flex justify-between items-center mb-4 border-b pb-4 border-color">
                <h3 class="text-2xl font-bold text-primary">Expense Report</h3>
                <button id="closeReportModalBtn" class="text-secondary hover:text-primary transition duration-300">
                    <i class="fas fa-times fa-2x"></i>
                </button>
            </div>
            
            <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                <span class="text-secondary text-sm font-medium">View Report By:</span>
                <select id="expenses-report-time-period" class="px-3 py-1 rounded-md border border-color input-field">
                    <option value="all">All Time</option>
                    <option value="daily" selected>Today</option>
                    <option value="weekly">This Week</option>
                    <option value="monthly">This Month</option>
                    <option value="yearly">This Year</option>
                </select>
            </div>

            <p class="text-lg font-bold text-primary mb-4">Total for this period: <span id="report-total" class="text-blue-600 dark:text-blue-400">₱0.00</span></p>

            <div id="report-modal-list-container" class="space-y-4">
                <ul id="expenses-list">
                    <!-- Expenses will be dynamically added here -->
                    <li class="text-muted text-center py-4" id="no-expenses-message">No expenses added yet.</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, setDoc, query, where, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

        setLogLevel('debug');

        const __app_id = "default-app-id";
        const addExpenseForm = document.getElementById('add-expense-form');
        const expensesList = document.getElementById('expenses-list');
        const logoutBtn = document.getElementById('logout-btn');
        const userEmailSpan = document.getElementById('user-email');
        const dailyTotalSpan = document.getElementById('daily-total');
        const weeklyTotalSpan = document.getElementById('weekly-total');
        const monthlyTotalSpan = document.getElementById('monthly-total');
        const yearlyTotalSpan = document.getElementById('yearly-total');
        const reportTotalSpan = document.getElementById('report-total');
        const noExpensesMessage = document.getElementById('no-expenses-message');
        const messageModal = document.getElementById('messageModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const reportTimePeriodSelect = document.getElementById('report-time-period');
        const expensesReportTimePeriodSelect = document.getElementById('expenses-report-time-period');
        const expensePieChartCanvas = document.getElementById('expense-pie-chart');
        const expenseLineChartCanvas = document.getElementById('expense-line-chart');
        const themeToggleBtn = document.getElementById('theme-toggle');
        const moonIcon = document.getElementById('moon-icon');
        const sunIcon = document.getElementById('sun-icon');
        const bodyElement = document.body;
        
        // New budget elements
        const setBudgetForm = document.getElementById('set-budget-form');
        const monthlyBudgetInput = document.getElementById('monthly-budget-input');
        const budgetAmountSpan = document.getElementById('budget-amount');
        const monthlySpentSpan = document.getElementById('monthly-spent');
        const budgetProgressBar = document.getElementById('budget-progress-bar');
        const budgetMessage = document.getElementById('budget-message');

        // New modal elements for report section
        const viewExpensesBtn = document.getElementById('view-expenses-btn');
        const reportModal = document.getElementById('reportModal');
        const closeReportModalBtn = document.getElementById('closeReportModalBtn');

        // Confirmation modal elements
        const confirmationModal = document.getElementById('confirmationModal');
        const cancelDeleteBtn = document.getElementById('cancelDeleteBtn');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');

        // Feedback confirmation modal elements
        const feedbackConfirmationModal = document.getElementById('feedbackConfirmationModal');
        const cancelFeedbackDeleteBtn = document.getElementById('cancelFeedbackDeleteBtn');
        const confirmFeedbackDeleteBtn = document.getElementById('confirmFeedbackDeleteBtn');


        // New feedback elements
        const feedbackForm = document.getElementById('feedback-form');
        const ratingStars = document.getElementById('rating-stars');
        const feedbackRatingInput = document.getElementById('feedback-rating');
        const feedbackCommentInput = document.getElementById('feedback-comment');
        const feedbackList = document.getElementById('feedback-list');
        const noFeedbackMessage = document.getElementById('no-feedback-message');

        let db, auth;
        let currentUserId = null;
        let allExpenses = [];
        let expensePieChart;
        let expenseLineChart;
        let monthlyBudget = 0; // Store the user's budget
        let expenseIdToDelete = null; // Store the ID of the expense to be deleted
        let feedbackIdToDelete = null; // Store the ID of the feedback to be deleted

        // --- Dark/Light Mode Logic ---
        const themePreference = localStorage.getItem('theme');
        if (themePreference === 'dark') {
            bodyElement.classList.add('dark-theme');
            moonIcon.classList.add('hidden');
            sunIcon.classList.remove('hidden');
        } else {
            bodyElement.classList.remove('dark-theme');
            moonIcon.classList.remove('hidden');
            sunIcon.classList.add('hidden');
        }

        themeToggleBtn.addEventListener('click', () => {
            if (bodyElement.classList.contains('dark-theme')) {
                bodyElement.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            } else {
                bodyElement.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            }
            // Update chart colors on theme change
            if (expensePieChart) {
                updateChartTheme(expensePieChart);
            }
            if (expenseLineChart) {
                updateChartTheme(expenseLineChart);
            }
        });

        // Custom Modal Functions
        function showModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.add('open', 'visible', 'opacity-100');
            modal.classList.remove('invisible', 'opacity-0');
        }

        function hideModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('open', 'visible', 'opacity-100');
            modal.classList.add('invisible', 'opacity-0');
        }

        function showMessage(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            showModal('messageModal');
        }

        closeModalBtn.addEventListener('click', () => hideModal('messageModal'));

        // Modal for Report Section
        viewExpensesBtn.addEventListener('click', () => {
            showModal('reportModal');
            renderExpensesList(allExpenses);
        });

        closeReportModalBtn.addEventListener('click', () => hideModal('reportModal'));

        // Initialize Firebase with the provided config
        try {
            const firebaseConfig = {
                apiKey: "AIzaSyBSEl_DhSpLxQQcLz-mV0jW7yIZfajA8rw",
                authDomain: "daily-expenses-tracker-19eda.firebaseapp.com",
                projectId: "daily-expenses-tracker-19eda",
                storageBucket: "daily-expenses-tracker-19eda.firebasestorage.app",
                messagingSenderId: "651286490733",
                appId: "1:651286490733:web:77c0267e72a101547e5964",
                measurementId: "G-VWCLRRBFKZ"
            };
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        } catch (e) {
            console.error("Firebase initialization error:", e);
        }

        // Auth state listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email || "Guest User";
                // Load budget and expenses
                await loadBudget(currentUserId);
                setupRealtimeExpensesListener(currentUserId);
                setupRealtimeFeedbackListener();
            } else {
                // If the user is not logged in, redirect to the login page
                window.location.href = 'index.html';
            }
        });

        // Function to calculate and update all totals for the summary boxes
        function updateSummaryTotals(expenses) {
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            let dailyTotal = 0, weeklyTotal = 0, monthlyTotal = 0, yearlyTotal = 0;

            expenses.forEach(expense => {
                const expenseDate = new Date(expense.timestamp);
                if (expenseDate >= today) dailyTotal += expense.amount;
                if (expenseDate >= startOfWeek) weeklyTotal += expense.amount;
                if (expenseDate >= startOfMonth) monthlyTotal += expense.amount;
                if (expenseDate >= startOfYear) yearlyTotal += expense.amount;
            });

            dailyTotalSpan.textContent = `₱${dailyTotal.toFixed(2)}`;
            weeklyTotalSpan.textContent = `₱${weeklyTotal.toFixed(2)}`;
            monthlyTotalSpan.textContent = `₱${monthlyTotal.toFixed(2)}`;
            yearlyTotalSpan.textContent = `₱${yearlyTotal.toFixed(2)}`;
        }

        // Function to render the expenses list based on a given period
        function renderExpensesList(expenses) {
            const period = expensesReportTimePeriodSelect.value;
            let filteredExpenses = [];
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            const startOfYear = new Date(now.getFullYear(), 0, 1);

            if (period === 'all') filteredExpenses = expenses;
            else if (period === 'daily') filteredExpenses = expenses.filter(exp => new Date(exp.timestamp) >= today);
            else if (period === 'weekly') filteredExpenses = expenses.filter(exp => new Date(exp.timestamp) >= startOfWeek);
            else if (period === 'monthly') filteredExpenses = expenses.filter(exp => new Date(exp.timestamp) >= startOfMonth);
            else if (period === 'yearly') filteredExpenses = expenses.filter(exp => new Date(exp.timestamp) >= startOfYear);
            
            const reportTotal = filteredExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            reportTotalSpan.textContent = `₱${reportTotal.toFixed(2)}`;

            expensesList.innerHTML = '';
            if (filteredExpenses.length === 0) {
                noExpensesMessage.classList.remove('hidden');
            } else {
                noExpensesMessage.classList.add('hidden');
                filteredExpenses.forEach((expense) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center card p-4 rounded-xl shadow-sm transition-colors duration-300 hover:shadow-md';
                    const formattedDate = new Date(expense.timestamp).toLocaleDateString();
                    li.innerHTML = `
                        <div class="flex-grow">
                            <p class="text-lg font-semibold text-primary">₱${parseFloat(expense.amount).toFixed(2)}</p>
                            <p class="text-sm text-secondary">${expense.description}</p>
                            <p class="text-xs text-muted">Added on: ${formattedDate}</p>
                        </div>
                        <div class="flex-shrink-0 text-right">
                            <p class="text-sm font-medium text-secondary">${expense.category}</p>
                            <button data-id="${expense.id}" class="delete-btn text-red-500 hover:text-red-700 transition duration-300">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    `;
                    expensesList.appendChild(li);
                });
            }
        }
        
        // Setup real-time listener for expenses
        function setupRealtimeExpensesListener(userId) {
            if (!userId) return;
            const q = query(collection(db, 'artifacts', __app_id, 'users', userId, 'expenses'), orderBy("timestamp", "desc"));
            
            onSnapshot(q, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ ...doc.data(), id: doc.id }));
                updateSummaryTotals(allExpenses);
                updateBudgetUI(allExpenses);
                generateReport(allExpenses);
                if (reportModal.classList.contains('open')) {
                    renderExpensesList(allExpenses);
                }
            }, (error) => {
                console.error("Error getting expenses: ", error);
                showMessage("Error", "Failed to load expenses. Please try again.");
            });
        }
        
        expensesReportTimePeriodSelect.addEventListener('change', () => renderExpensesList(allExpenses));

        // Helper function to update chart colors based on theme
        function updateChartTheme(chart) {
            const isDarkTheme = bodyElement.classList.contains('dark-theme');
            const textColor = isDarkTheme ? '#f9fafb' : '#1f2937';
            const gridColor = isDarkTheme ? '#4b5563' : '#d1d5db';
            chart.options.plugins.legend.labels.color = textColor;
            if (chart.options.scales.x) {
                chart.options.scales.x.ticks.color = textColor;
                chart.options.scales.x.grid.color = gridColor;
                if(chart.options.scales.x.title) chart.options.scales.x.title.color = textColor;
            }
            if (chart.options.scales.y) {
                chart.options.scales.y.ticks.color = textColor;
                chart.options.scales.y.grid.color = gridColor;
                if(chart.options.scales.y.title) chart.options.scales.y.title.color = textColor;
            }
            chart.update();
        }

        // Generate and show report
        function generateReport(expensesData) {
            // This function remains the same as your updated version
            const period = reportTimePeriodSelect.value;
            let filteredExpenses = [];
            const now = new Date();

            if (period === 'daily') {
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                filteredExpenses = expensesData.filter(exp => new Date(exp.timestamp) >= today);
            } else if (period === 'weekly') {
                const startOfWeek = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay());
                filteredExpenses = expensesData.filter(exp => new Date(exp.timestamp) >= startOfWeek);
            } else if (period === 'monthly') {
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                filteredExpenses = expensesData.filter(exp => new Date(exp.timestamp) >= startOfMonth);
            } else if (period === 'yearly') {
                const startOfYear = new Date(now.getFullYear(), 0, 1);
                filteredExpenses = expensesData.filter(exp => new Date(exp.timestamp) >= startOfYear);
            }

            const reportByCategory = filteredExpenses.reduce((acc, expense) => {
                acc[expense.category] = (acc[expense.category] || 0) + expense.amount;
                return acc;
            }, {});

            let timeLabels = [];
            let spendingDataByCategories = {};
            const categories = Array.from(new Set(filteredExpenses.map(exp => exp.category)));

            const colors = { 'Food': '#3B82F6', 'Shopping': '#EF4444', 'Bills': '#10B981', 'Entertainment': '#F59E0B', 'Transportation': '#6366F1', 'Other': '#9CA3AF' };

            if (period === 'daily') {
                timeLabels = Array.from({length: 24}, (_, i) => new Date(0,0,0,i).toLocaleTimeString('en-US', {hour: 'numeric', hour12: true}));
                categories.forEach(cat => { spendingDataByCategories[cat] = new Array(24).fill(0); });
                filteredExpenses.forEach(exp => {
                    const hour = new Date(exp.timestamp).getHours();
                    if(spendingDataByCategories[exp.category]) spendingDataByCategories[exp.category][hour] += exp.amount;
                });
            } else if (period === 'weekly') {
                timeLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                categories.forEach(cat => { spendingDataByCategories[cat] = new Array(7).fill(0); });
                filteredExpenses.forEach(exp => {
                    const day = new Date(exp.timestamp).getDay();
                    if(spendingDataByCategories[exp.category]) spendingDataByCategories[exp.category][day] += exp.amount;
                });
            } else if (period === 'monthly') {
                 const monthlyTotals = {};
                 for (let i = 11; i >= 0; i--) {
                     const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                     monthlyTotals[d.toLocaleString('default', { month: 'short', year: 'numeric' })] = 0;
                 }
                 filteredExpenses.forEach(exp => {
                     const monthStr = new Date(exp.timestamp).toLocaleString('default', { month: 'short', year: 'numeric' });
                     if (monthlyTotals.hasOwnProperty(monthStr)) monthlyTotals[monthStr] += exp.amount;
                 });
                 timeLabels = Object.keys(monthlyTotals);
                 spendingDataByCategories['Total'] = Object.values(monthlyTotals);
            } else if (period === 'yearly') {
                const yearlyTotals = {};
                for (let i = 4; i >= 0; i--) yearlyTotals[now.getFullYear() - i] = 0;
                filteredExpenses.forEach(exp => {
                    const year = new Date(exp.timestamp).getFullYear();
                    if (yearlyTotals.hasOwnProperty(year)) yearlyTotals[year] += exp.amount;
                });
                timeLabels = Object.keys(yearlyTotals);
                spendingDataByCategories['Total'] = Object.values(yearlyTotals);
            }
            
            const datasets = Object.keys(spendingDataByCategories).map(category => ({
                label: category,
                data: spendingDataByCategories[category],
                borderColor: colors[category] || '#9CA3AF',
                backgroundColor: (colors[category] || '#9CA3AF') + '33',
                tension: 0.1,
                fill: true
            }));

            const labels = Object.keys(reportByCategory);
            const data = Object.values(reportByCategory);

            if (expensePieChart) expensePieChart.destroy();
            expensePieChart = new Chart(expensePieChartCanvas.getContext('2d'), { type: 'pie', data: { labels, datasets: [{ data, backgroundColor: Object.values(colors), borderColor: bodyElement.classList.contains('dark-theme') ? '#1f2937' : '#ffffff', borderWidth: 2 }] }, options: { responsive: true, plugins: { legend: { labels: { color: bodyElement.classList.contains('dark-theme') ? '#f9fafb' : '#1f2937' } } } } });
            
            if (expenseLineChart) expenseLineChart.destroy();
            expenseLineChart = new Chart(expenseLineChartCanvas.getContext('2d'), { type: 'line', data: { labels: timeLabels, datasets }, options: { responsive: true, scales: { x: { title: { display: true, text: 'Time' } }, y: { title: { display: true, text: 'Amount (₱)' }, beginAtZero: true } } } });
            
            updateChartTheme(expensePieChart);
            updateChartTheme(expenseLineChart);
        }
        
        reportTimePeriodSelect.addEventListener('change', () => generateReport(allExpenses));

        // Function to load the user's budget from Firestore
        async function loadBudget(userId) {
            if (!userId) return;
            const budgetDocRef = doc(db, 'artifacts', __app_id, 'users', userId, 'budget', 'monthlyBudget');
            try {
                const docSnap = await getDoc(budgetDocRef);
                if (docSnap.exists()) {
                    monthlyBudget = docSnap.data().amount;
                    monthlyBudgetInput.value = monthlyBudget;
                } else {
                    monthlyBudget = 0;
                }
                updateBudgetUI(allExpenses);
            } catch (error) {
                console.error("Error loading budget:", error);
            }
        }

        // Function to update the budget UI (progress bar and totals)
        function updateBudgetUI(expenses) {
            if (!budgetMessage) return; // Guard against the element not being found
            const now = new Date();
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            const monthlySpent = expenses
                .filter(exp => new Date(exp.timestamp) >= startOfMonth)
                .reduce((sum, exp) => sum + exp.amount, 0);

            monthlySpentSpan.textContent = `₱${monthlySpent.toFixed(2)}`;
            budgetAmountSpan.textContent = `₱${Number(monthlyBudget).toFixed(2)}`;

            if (monthlyBudget > 0) {
                const percentage = (monthlySpent / monthlyBudget) * 100;
                let colorClass = 'bg-blue-600';
                if (percentage >= 100) {
                    colorClass = 'bg-red-500';
                    budgetMessage.textContent = "You have exceeded your budget!";
                    budgetMessage.className = 'text-sm mt-2 text-center text-red-500';
                } else if (percentage >= 80) {
                    colorClass = 'bg-yellow-500';
                    budgetMessage.textContent = "Getting close to your budget limit.";
                    budgetMessage.className = 'text-sm mt-2 text-center text-yellow-500';
                } else {
                    budgetMessage.textContent = "You're doing great with your budget!";
                    budgetMessage.className = 'text-sm mt-2 text-center text-muted';
                }
                
                budgetProgressBar.className = `h-4 rounded-full transition-all duration-500 ${colorClass}`;
                budgetProgressBar.style.width = `${Math.min(percentage, 100)}%`;
            } else {
                budgetMessage.textContent = "Set a budget to start tracking!";
                budgetMessage.className = 'text-sm mt-2 text-center text-muted';
                budgetProgressBar.style.width = '0%';
                budgetProgressBar.className = `h-4 rounded-full transition-all duration-500 bg-blue-600`;
            }
        }

        // Add a new expense to Firestore
        addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const amount = addExpenseForm['expense-amount'].value;
            const category = addExpenseForm['expense-category'].value;
            const description = addExpenseForm['expense-description'].value;
            try {
                await addDoc(collection(db, 'artifacts', __app_id, 'users', currentUserId, 'expenses'), {
                    amount: parseFloat(amount), category, description, timestamp: new Date().toISOString()
                });
                addExpenseForm.reset();
            } catch (error) {
                console.error("Error adding expense: ", error);
                showMessage("Error", "Failed to add expense. Please try again.");
            }
        });
        
        // Save the budget to Firestore
        setBudgetForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId) return;
            const budget = parseFloat(monthlyBudgetInput.value);
            if (isNaN(budget) || budget <= 0) {
                showMessage("Invalid Budget", "Please enter a valid amount greater than 0.");
                return;
            }
            try {
                const budgetDocRef = doc(db, 'artifacts', __app_id, 'users', currentUserId, 'budget', 'monthlyBudget');
                await setDoc(budgetDocRef, { amount: budget });
                monthlyBudget = budget;
                updateBudgetUI(allExpenses);
                showMessage("Success", "Monthly budget has been updated!");
            } catch (error) {
                console.error("Error saving budget:", error);
                showMessage("Error", "Failed to save budget. Please try again.");
            }
        });

        // Event listener for delete buttons in the expense list
        expensesList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                expenseIdToDelete = deleteBtn.dataset.id;
                showModal('confirmationModal');
            }
        });

        // Event listener for the final delete confirmation
        confirmDeleteBtn.addEventListener('click', async () => {
            if (!expenseIdToDelete || !currentUserId) return;
            try {
                await deleteDoc(doc(db, 'artifacts', __app_id, 'users', currentUserId, 'expenses', expenseIdToDelete));
                // The onSnapshot listener will handle the UI update automatically.
            } catch (error) {
                console.error("Error deleting expense: ", error);
                showMessage("Error", "Failed to delete expense. Please try again.");
            } finally {
                hideModal('confirmationModal');
                expenseIdToDelete = null;
            }
        });

        cancelDeleteBtn.addEventListener('click', () => {
            hideModal('confirmationModal');
            expenseIdToDelete = null;
        });
        
        // Logout user
        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });

        // --- Feedback and Rating Section Logic ---
        let currentRating = 0;

        ratingStars.addEventListener('click', (e) => {
            const star = e.target.closest('i');
            if (!star) return;
            currentRating = parseInt(star.dataset.rating);
            feedbackRatingInput.value = currentRating;
            const stars = ratingStars.querySelectorAll('i');
            stars.forEach(s => {
                s.classList.toggle('text-yellow-400', parseInt(s.dataset.rating) <= currentRating);
                s.classList.toggle('text-gray-400', parseInt(s.dataset.rating) > currentRating);
            });
        });

        feedbackForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUserId || currentRating === 0) return;
            try {
                await addDoc(collection(db, `artifacts/${__app_id}/public/data/feedback`), {
                    rating: currentRating, 
                    comment: feedbackCommentInput.value, 
                    timestamp: new Date().toISOString(), 
                    userEmail: auth.currentUser.email,
                    userId: currentUserId // Save the user's ID
                });
                showMessage("Thank you!", "Your feedback has been submitted.");
                feedbackForm.reset();
                currentRating = 0;
                ratingStars.querySelectorAll('i').forEach(s => {
                    s.classList.remove('text-yellow-400');
                    s.classList.add('text-gray-400');
                });
            } catch (error) {
                console.error("Error submitting feedback:", error);
            }
        });

        function setupRealtimeFeedbackListener() {
            const q = query(collection(db, `artifacts/${__app_id}/public/data/feedback`), orderBy("timestamp", "desc"));
            onSnapshot(q, (snapshot) => {
                feedbackList.innerHTML = '';
                noFeedbackMessage.classList.toggle('hidden', !snapshot.empty);
                snapshot.forEach((doc) => {
                    const feedback = doc.data();
                    const li = document.createElement('li');
                    li.className = 'p-4 rounded-xl card shadow-sm';
                    const starsHTML = Array(5).fill(0).map((_, i) => 
                        `<i class="fas fa-star ${i < feedback.rating ? 'text-yellow-400' : 'text-gray-400'}"></i>`
                    ).join('');

                    const isOwner = feedback.userId && feedback.userId === currentUserId;

                    li.innerHTML = `
                        <div class="flex justify-between items-start">
                             <div>
                                <div class="flex items-center mb-2">${starsHTML}</div>
                                <p class="text-secondary text-sm mb-2">${feedback.comment}</p>
                                <p class="text-xs text-muted">by ${feedback.userEmail || 'Anonymous'} on ${new Date(feedback.timestamp).toLocaleDateString()}</p>
                             </div>
                             ${isOwner ? `<button data-id="${doc.id}" class="feedback-delete-btn text-red-500 hover:text-red-700 transition duration-300 ml-4 flex-shrink-0">
                                            <i class="fas fa-trash-alt"></i>
                                         </button>` : ''}
                        </div>
                    `;
                    feedbackList.appendChild(li);
                });
            });
        }

        feedbackList.addEventListener('click', (e) => {
            const deleteBtn = e.target.closest('.feedback-delete-btn');
            if (deleteBtn) {
                feedbackIdToDelete = deleteBtn.dataset.id;
                showModal('feedbackConfirmationModal');
            }
        });

        confirmFeedbackDeleteBtn.addEventListener('click', async () => {
            if (!feedbackIdToDelete || !currentUserId) return;
            try {
                const feedbackDocRef = doc(db, `artifacts/${__app_id}/public/data/feedback`, feedbackIdToDelete);
                await deleteDoc(feedbackDocRef);
                showMessage("Success", "Your feedback has been deleted.");
            } catch (error) {
                console.error("Error deleting feedback: ", error);
                showMessage("Error", "Failed to delete feedback. Please try again.");
            } finally {
                hideModal('feedbackConfirmationModal');
                feedbackIdToDelete = null;
            }
        });

        cancelFeedbackDeleteBtn.addEventListener('click', () => {
            hideModal('feedbackConfirmationModal');
            feedbackIdToDelete = null;
        });

    </script>
</body>
</html>

